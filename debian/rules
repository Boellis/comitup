#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS=nocheck

export PYBUILD_DISABLE=test

include /usr/share/dpkg/pkg-info.mk

VER = $(shell (echo ${DEB_VERSION}) | sed 's/[-\+].\+//')
PRODUCT_VER = $(shell (grep -e "^\s*version" setup.py | tail -1 |  sed 's/[^0-9\.]//g'))


manpages = $(shell (ls doc/*.md | sed 's/.md//'))

export PYBUILD_NAME=comitup
export PYBUILD_INSTALL_ARGS=--install-lib=/usr/share/comitup\
 --install-scripts=/usr/share/comitup

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_clean:
	dh_auto_clean
	./debian/release_check || echo "\nRELEASE CHECK FAILURE\n"

override_dh_auto_build:
	if [ "${VER}" != "${PRODUCT_VER}" ] ; then exit 1 ; fi
	dh_auto_build
	uglifyjs web/templates/js/uikit.js -m -c >web/templates/js/uikit.min.js
	for mn in ${manpages}; do \
	  pandoc $$mn.md -s -t man -o $$mn; \
	  sed -i 's/\\\[en\]/\\\-/' $$mn; \
	done

override_dh_installsystemd:
	dh_installsystemd
	dh_installsystemd --name=comitup-web
